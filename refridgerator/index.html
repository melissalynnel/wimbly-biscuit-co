<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>wimbly biscuit co. is proud of you</title>
    <meta name="description" content="an illustrated refrigerator for collected art" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@500;700&family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://use.typekit.net/vyy0wuq.css" />
    <link rel="stylesheet" href="styles.css?v=1" />
  </head>
  <body>
    <main class="page">
      <section class="fridge-scroll" aria-labelledby="title">
        <header class="fridge-header">
          <h1 id="title">absurdities provided by<br />wimbly biscuit co.</h1>
        </header>

        <div class="fridge-stack" role="img" aria-label="a towering illustrated refrigerator">
          <div class="fridge-segment segment-top">
            <span class="handle handle-vert handle-top"></span>
          </div>

          <div class="fridge-segment segment-door">
            <span class="handle handle-vert handle-bottom"></span>
            <figure class="fridge-art fridge-art-front">
              <img src="assets/wimblycat001.jpg" alt="white line art cat with heart and stars" />
              <figcaption>by Haley Raven</figcaption>
            </figure>
          </div>
        </div>

        <div class="art-stage" id="artStage" aria-label="art workspace">
          <input class="file-input" id="artInput" type="file" accept="image/*" />
        </div>
      </section>
    </main>

    <script>
      const artInput = document.getElementById("artInput");
      const artStage = document.getElementById("artStage");

      const storedArtKey = "wimbly-fridge-art";

      const loadStoredArt = () => {
        const raw = localStorage.getItem(storedArtKey);
        if (!raw) return;
        try {
          const items = JSON.parse(raw);
          items.forEach((item) => {
            const img = createArtImage(item.src);
            img.style.left = item.left;
            img.style.top = item.top;
            img.style.transform = item.transform;
          });
        } catch {
          localStorage.removeItem(storedArtKey);
        }
      };

      const saveArtPositions = () => {
        const items = Array.from(artStage.querySelectorAll(".art-piece")).map((img) => ({
          src: img.dataset.src,
          left: img.style.left,
          top: img.style.top,
          transform: img.style.transform,
        }));
        localStorage.setItem(storedArtKey, JSON.stringify(items));
      };

      const createArtImage = (src) => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "uploaded art";
        img.className = "art-piece";
        img.dataset.src = src;
        img.style.left = "10%";
        img.style.top = "20%";
        img.style.transform = `rotate(${Math.random() * 6 - 3}deg)`;
        artStage.appendChild(img);
        makeDraggable(img);
        return img;
      };

      const makeDraggable = (el) => {
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let originX = 0;
        let originY = 0;

        const onPointerDown = (event) => {
          if (event.pointerType === "mouse" && event.button !== 0) return;
          isDragging = true;
          el.setPointerCapture(event.pointerId);
          const rect = el.getBoundingClientRect();
          startX = event.clientX;
          startY = event.clientY;
          originX = rect.left;
          originY = rect.top;
          el.classList.add("dragging");
        };

        const onPointerMove = (event) => {
          if (!isDragging) return;
          const stageRect = artStage.getBoundingClientRect();
          const nextLeft = originX + (event.clientX - startX) - stageRect.left;
          const nextTop = originY + (event.clientY - startY) - stageRect.top;
          el.style.left = `${Math.max(0, Math.min(nextLeft, stageRect.width - el.offsetWidth))}px`;
          el.style.top = `${Math.max(0, Math.min(nextTop, stageRect.height - el.offsetHeight))}px`;
        };

        const onPointerUp = (event) => {
          if (!isDragging) return;
          isDragging = false;
          el.releasePointerCapture(event.pointerId);
          el.classList.remove("dragging");
          saveArtPositions();
        };

        el.addEventListener("pointerdown", onPointerDown);
        el.addEventListener("pointermove", onPointerMove);
        el.addEventListener("pointerup", onPointerUp);
        el.addEventListener("pointercancel", onPointerUp);
      };

      artInput?.addEventListener("change", (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          createArtImage(reader.result);
          saveArtPositions();
        };
        reader.readAsDataURL(file);
        artInput.value = "";
      });

      loadStoredArt();
    </script>
  </body>
</html>
